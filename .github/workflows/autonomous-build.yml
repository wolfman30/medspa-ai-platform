name: Autonomous MVP Build

# Manual trigger with configurable parameters
on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Build instructions (leave empty for default MVP completion)'
        required: false
        default: ''
      max_turns:
        description: 'Maximum turns per stage (default: 50)'
        required: false
        default: '50'
      stage:
        description: 'Which stage to run (all, test-fix, features, hardening)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - test-fix
          - features
          - hardening

env:
  GO_VERSION: '1.24.12'
  GOTOOLCHAIN: auto

jobs:
  # Stage 1: Fix any failing tests
  test-fix:
    name: Stage 1 - Fix Failing Tests
    runs-on: ubuntu-latest
    if: inputs.stage == 'all' || inputs.stage == 'test-fix'
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run Claude Code - Fix Tests
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        prompt: |
          ${{ inputs.prompt || 'Fix all failing tests in the codebase.' }}

          Steps:
          1. Run `go test -v ./tests/...` to see current acceptance test status
          2. Run `go test -v ./...` to see all unit test status
          3. Fix each failing test by understanding the root cause
          4. Re-run tests after each fix to verify
          5. Continue until all tests pass

          Definition of done: All tests pass with `go test -v ./...`
        claude_args: |
          --max-turns ${{ inputs.max_turns }}
          --allowedTools "Read,Write,Edit,Bash,Glob,Grep"

    - name: Commit any changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --staged --quiet || git commit -m "fix: Auto-fix failing tests

        ðŸ¤– Generated by autonomous build workflow"
        git push || echo "No changes to push"

  # Stage 2: Implement missing features
  features:
    name: Stage 2 - Implement Features
    runs-on: ubuntu-latest
    needs: test-fix
    if: always() && (inputs.stage == 'all' || inputs.stage == 'features')
    permissions:
      contents: write
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run Claude Code - Features
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        prompt: |
          Implement missing MVP features based on docs/MVP_STATUS.md.

          Steps:
          1. Read docs/MVP_STATUS.md to understand remaining gaps
          2. For each P1 gap, implement the feature
          3. Write tests for new code
          4. Run tests after each feature
          5. Update MVP_STATUS.md when completing items

          Focus on these P1 items from MVP_STATUS.md:
          - Client portal authentication
          - Clinic profile management
          - Square OAuth connect in portal
          - Telnyx 10DLC registration workflow

          Write clean, tested code following CLAUDE.md guidelines.
        claude_args: |
          --max-turns ${{ inputs.max_turns }}
          --allowedTools "Read,Write,Edit,Bash,Glob,Grep"

    - name: Commit any changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --staged --quiet || git commit -m "feat: Auto-implement MVP features

        ðŸ¤– Generated by autonomous build workflow"
        git push || echo "No changes to push"

  # Stage 3: Hardening and documentation
  hardening:
    name: Stage 3 - Hardening & Docs
    runs-on: ubuntu-latest
    needs: features
    if: always() && (inputs.stage == 'all' || inputs.stage == 'hardening')
    permissions:
      contents: write
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run Claude Code - Hardening
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        prompt: |
          Harden the codebase and update documentation.

          Steps:
          1. Ensure TWILIO_SKIP_SIGNATURE is not used in production code
          2. Verify all environment variable handling is secure
          3. Check for any hardcoded secrets
          4. Update operational runbooks in docs/
          5. Update MVP_STATUS.md with final status
          6. Ensure all tests pass

          Definition of done: All acceptance tests pass and MVP_STATUS.md shows 100% complete.
        claude_args: |
          --max-turns ${{ inputs.max_turns }}
          --allowedTools "Read,Write,Edit,Bash,Glob,Grep"

    - name: Commit any changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --staged --quiet || git commit -m "chore: Hardening and documentation updates

        ðŸ¤– Generated by autonomous build workflow"
        git push || echo "No changes to push"

  # Final verification
  verify:
    name: Final Verification
    runs-on: ubuntu-latest
    needs: [test-fix, features, hardening]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run all tests
      run: |
        go test -v ./tests/...
        go test -v ./...

    - name: Build verification
      run: go build -v ./...

    - name: Summary
      run: |
        echo "## Autonomous Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        go test -v ./tests/... 2>&1 | tail -20 >> $GITHUB_STEP_SUMMARY || true
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### MVP Status" >> $GITHUB_STEP_SUMMARY
        head -30 docs/MVP_STATUS.md >> $GITHUB_STEP_SUMMARY || true
