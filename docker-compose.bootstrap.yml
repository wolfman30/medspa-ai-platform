version: "3.8"

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    env_file:
      - .env
    environment:
      PORT: "8081"
      USE_MEMORY_QUEUE: "true"
      WORKER_COUNT: ${WORKER_COUNT:-2}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_ADDR: ${REDIS_ADDR:-127.0.0.1:6379}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      TELNYX_API_KEY: ${TELNYX_API_KEY}
      TELNYX_MESSAGING_PROFILE_ID: ${TELNYX_MESSAGING_PROFILE_ID}
      TELNYX_WEBHOOK_SECRET: ${TELNYX_WEBHOOK_SECRET}
      SQUARE_ACCESS_TOKEN: ${SQUARE_ACCESS_TOKEN}
      SQUARE_LOCATION_ID: ${SQUARE_LOCATION_ID}
      SQUARE_WEBHOOK_SIGNATURE_KEY: ${SQUARE_WEBHOOK_SIGNATURE_KEY}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER}
    restart: unless-stopped
    network_mode: host
